#
# Nginx and Mongo Dockerfile
# https://github.com/dockerfile/nginx
# Dockerizing MongoDB: Dockerfile for building MongoDB images
# Based on ubuntu:latest, installs MongoDB following the instructions from:
# http://docs.mongodb.org/manual/tutorial/install-mongodb-on-ubuntu/

# Pull base image.
FROM ubuntu:latest
MAINTAINER seris

# Install MONGODB
# Import MongoDB public GPG key AND create a MongoDB list file
RUN \
  apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 7F0CEB10 && \
  echo 'deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen' > /etc/apt/sources.list.d/mongodb.list && \
  apt-get update && \
  apt-get install -y mongodb-org && \
  rm -rf /var/lib/apt/lists/*

# Define mountable directories.
# this VOLUME ["/data/db"] will go with the VOLUME from nginx below 

# Define working directory.
WORKDIR /data

# Define default command.
#CMD ["mongod"] -- this has been included in a startup shell script so both mongo and nginx are started

# Expose ports.
#   - 27017: process
#   - 28017: http
EXPOSE 27017
EXPOSE 28017

# Install NGINX
# removed this line as first RUN   add-apt-repository -y ppa:nginx/stable && \
RUN \
  apt-get update && \
  apt-get install -y nginx && \
  rm -rf /var/lib/apt/lists/* && \
  echo "\ndaemon off;" >> /etc/nginx/nginx.conf && \
  chown -R www-data:www-data /var/lib/nginx && \
  echo "/usr/bin/mongod &\n/usr/sbin/nginx" > /etc/onstartup.sh

# Define mountable directories.
VOLUME ["/etc/nginx/sites-enabled", "/etc/nginx/certs", "/etc/nginx/conf.d", "/var/log/nginx", "/var/www/html", "/data/db"]

# Define working directory.
WORKDIR /etc/nginx

# Define default command. This should start the mongod and nginx deamons
CMD ["/bin/bash", "/etc/onstartup.sh"]

# Expose ports.
EXPOSE 80
EXPOSE 443
